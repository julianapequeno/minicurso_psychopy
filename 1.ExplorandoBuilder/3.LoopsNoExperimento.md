## Loops no experimento
Bom, como voc√™ pode ver, podemos construir um experimento utilizando o `Builder View` dentro do software Psychopy. Mas, como podemos deixar essa experimento completo? At√© agora, o participante vai visualizar o componente da `seta` na tela por `1.0 segundo` e logo depois ver√° o `target`, ent√£o ir√° indicar por meio do teclado onde est√° o target (na esquerda ou na direita).

Mas, para que possamos completar, √© necess√°rio realizar isso v√°rias vezes n√£o √©? Ent√£o, vamos introduzir aqui o conceito de `Loop`.

:lollipop: `Loop` √© literalmente um la√ßo, um la√ßo de repeti√ß√£o. Isto √©, representa uma estrutura que vai se repetir um trecho do c√≥digo por um n√∫mero determinado de vezes. Para j√° irmos entendendo um pouco de python, na linguagem, o loop tem essa cara:

```python
for i in range(0,11):
    print(i)
```

O c√≥digo acima representa um loop que vai de 0 at√© 10 (o segundo par√¢metro do `range` √© exclusivo) e imprime cada n√∫mero na tela, assim a sa√≠da √© a seguinte:

```python
1
2
3
4
5
6
7
8
9
10
```

Bom, ent√£o como isso se aplica no nosso experimento? Vamos conhecer a fun√ß√£o `LOOP`.

- Os componentes do tipo `loop` controlam repeti√ß√µes de `Routines`. Eles possuem um nome, s√£o √∫nicos e podem ter seus par√¢metros alterados de acordo com a necessidade e requisitos do experimento.

### üê§ Passo a passo | Trabalhando com Loops 

<br>

1. Insira um novo `loop` clicando no `Insert Loop` localizado no canto inferior esquerdo da tela, dentro do componente `Flow`.
<br>
<br>
<div align="center">
<img src="images/insert_loop.jpeg" height=300 >
</div>
<br>

2. A seguinte tela vai abrir, mostrando as propriedades do componente `loop`.
<br>
<br>
<div align="center">
<img src="images/loop_prop.jpeg" height=300 >
</div>
<br>

A checkbox _isTrials_ indica que ap√≥s cada repeti√ß√£o do loop uma nova linha ser√° adicionada ao arquivo que √© retornado ao final do experimento. 
Isto √©, cada a checkbox esteja marcada, a planilha ao final do experimento apresentar√° o resultado de cada uma das trials, caso o usu√°rio acertou, em quanto tempo, qual era a reposta correta. Mas esses par√¢metros que estou comentando aqui podem variar tamb√©m. Depende de como voc√™, pesquisador, definir em cada componente o que ele vai guardar. Normalmente este par√¢metro √© marcado quando o `loop` demarcam a repeti√ß√£o de `trials`, isso porque alguns loops podem demarcar a repeti√ß√£o de blocos de trials, mas isso veremos um pouco mais a frente... :)

Antes, de falarmos sobre isso, irei mostrar um exemplo de retorno da tabela ao final do experimento com o `isTrials` marcado.

### Afinal, o que temos ao final do experimento rodar? A pasta `Data` üìÉ
Bom, j√° comentei bastante por aqui sobre a exist√™ncia de um arquivo que o programa gera ao final do seu experimento. Entretanto, ainda h√° muito mais a se falar sobre essa ele. 

Assim que voc√™ roda o experimento pela primeira vez, o psychopy vai criar uma pasta chamada `Data` no seu computador, localizada no mesmo local onde o seu experimento `.psyexp` est√°. Nesta pasta, por padr√£o, ser√£o gerados tr√™s tipos de arquivos diferentes ao final de um experimento. Esse s√£o um excel data file, log file e um data file (`.psydat`).
    
- log file: √© um arquivo de `logging`, um arquivo que guarda os acontecimentos dentro do programa em ordem cronol√≥gica. Ex: chamadas de fun√ß√£o, etc.
- excel data file:  essa √© a planilha que retorna todos os resultados do participante naquele experimento que foram captados pelo Psychopy.
- Psychopy data file (.psydat): arquivos que guardam dados que normalmente voc√™ esqueceu de salvar pelo Psychopy. S√£o usados por usu√°rios com um pouco mais de experi√™ncia em python e talvez matplolib (uma biblioteca do python).

Aqui, o arquivo que nos interessa (pelo menos geralmente, mas depende do seu experimento), √© o arquivo de excel.

> Certo, mas que atributos s√£o esses? Como posso interpretar? Pegar um dado espec√≠fico? ü§î

Como voc√™ bem sabe, existem diferentes tipos de experimentos, e claramente cada um deles tem objetivos diferentes. Ent√£o talvez alguns dados fa√ßam mais sentido para uns e menos sentido para outros. 

Em primeiro lugar, se voc√™ consultar a aba `Experiment info`, aquela que falamos h√° alguns t√≥picos atr√°s com uma engrenagem como logo, ela tem uma aba chamada `Data`. Nessa aba voc√™ pode realizar as configura√ß√µes gerais da pasta. Como por exemplo, definir se voc√™ quer que o programa gere os tr√™s tipos diferentes de arquivo mesmo, ou se quer apenas 1 deles, o `.csv` por exemplo. Tamb√©m mudar o padr√£o de nome dos arquivos, a forma como ele √© gerado...Por padr√£o, ele une o nome do participante com a hora que o experimento ocorreu.

Al√©m disso, cada componente do Psychopy tem uma aba chamada `Data`, nesta aba voc√™ consegue definir se quer guardar dados daquele componente em sua resposta ou n√£o. Por exemplo, o `Camera Component` permite que voc√™ defina se quer salvar o v√≠deo que foi gravado durante o experimento. 

O psychopy consegue ir ainda mais al√©m do que salvar, em alguns componentes voc√™ ainda consegue definir a resposta correta em um campo chamado `correct answer` e a resgatar de uma planilha adicionada ao projeto. Depois disso, guardar caso o participante acertou ou n√£o.

### üçÅ Elementos do `Loop`
Okay, esse foi um loooongo par√™nteses, n√£o √© mesmo? Que tal voltarmos a falar sobre o componente `loop`? Haviam v√°rios outros campos que n√£o comentamos ainda. Vamos nos debru√ßar sobre cada um?

<br>
<br>
<div align="center">
<img src="images/loop_prop.jpeg" height=300 >
</div>
<br>

- `Num. repeats` representa a quantidade de vezes que voc√™ deseja repetir cada uma das condi√ß√µes que est√£o na sua planilha. Isto √©, para cada linha o valor/imagem/texto aparecer√° X vezes no experimento.
    Por exemplo,
    | nomes |
    | -- |
    | Maria |
    | Jos√© |
    | Davi |

    Note que, neste exemplo, temos tr√™s valores da coluna `nomes`, os valores s√£o: "Maria", "Jos√©" e "Davi". Se o campo `Num. repeats` estiver com o valor `5`, ent√£o teremos uma lista do tipo:
    ```
    Maria
    Maria
    Maria
    Maria
    Maria
    Jos√©
    Jos√©
    Jos√©
    Jos√©
    Jos√©
    Davi
    Davi
    Davi
    Davi
    Davi
    ``` 
    Onde cada rodada do `loop` atribuir√° um desses valores √† vari√°vel `nomes` - que √© o nome da coluna da planilha. (Falaremos sobre vari√°veis dentro do Psychopy no pr√≥ximo t√≥pico)
    
    O que nos leva ao pr√≥ximo campo.
- `Loop type` representa a forma de aleatoriedade ou n√£o que voc√™ deseja no seu la√ßo. Existem algumas op√ß√µes, vou abordar de forma sucinta aqui sobre cada uma delas, por√©m caso voc√™ deseje saber mais, tem uma p√°gina inteira sobre isso na documenta√ß√£o do Psychopy. 
<br>
<br>
<div align="center">
<img src="images/loop_types.jpeg" height=300 >
</div>
<br>

- 
    - Random: apresenta a lista em uma ordem aleat√≥ria.
    - Sequential: apresenta as linhas na ordem em  que elas aparecem na planilha.
    - fullRandom: apresenta a lista em uma ordem aleat√≥ria mas tamb√©m leva em conta o n√∫mero de nReps. Isto √©, randomiza n√£o apenas os valores contidos na planilha, mas tamb√©m as repeti√ß√µes desses valores. No caso da lista que apresentei acima com os tr√™s nomes, seria como aleatorizar a ordem daquela lista. Enquanto no `Random` s√≥ aleatoriza a ordem de apari√ß√£o de cada um dos tr√™s elementos: ['Maria', 'Jos√©', 'Davi'].
    - Staircase: √© usado para que os pesquisadores possam medir o desempenho e n√∫mero de trials realizados por um participante com base em n√≠veis. Cria uma vari√°vel chamada `Level` que pode definir par√¢metros de um est√≠mulo de acordo com o n√≠vel em que o participante est√°.
    - interleved staircases: s√£o v√°rias staircases intercaladas.

- `Selected rows`√© o campo onde pode-se especificar quais as linhas da planilha ser√£o usadas no experimento. Consequentemente, quais linhas ser√£o randomizadas, duplicadas, etc...Dependendo das entradas que falei acima.
- `Random Seed`, para algumas atividades, precisamos que a ordem rand√¥mica se mantenha a mesma. Esse conceito √© usado em v√°rias √°reas e outras aplica√ß√µes da matem√°tica computacional. Assim, caso seja uma realidade do seu projeto, esse √© o campo para inserir essa semente, e assim resultar√° na lista pr√© organizada. 
    - Para os que n√£o conhecem muito esse conceito, imagine uma prova sobre n√∫meros rand√¥micos. O professor fez uma plataforma que voc√™ precisa enviar o c√≥digo e o resultado gerado deve ser igual ao resultado que ele j√° colou l√°. Como garantimos isso caso utilizemos o random geral? Bom, essa √© uma aplica√ß√£o do seed, ou semente. √â literalmente como uma semente de gera√ß√£o, por meio da aplica√ß√£o dela, sabemos que os n√∫meros, ao serem randomizados, ficar√£o em uma ordem espec√≠fica. Por isso, caso tenhamos uma situa√ß√£o contr√°ria, onde n√£o queremos o mesmo resultado, √© importante aleatorizar o seed tamb√©m.
- `Conditions` √© o campo onde adicionamos uma planilha que cont√©m os dados que ser√£o utilizados no nosso experimento. Vou dar um exemplo. Imagine que uma parte do experimento √© mostrar 5 imagens por 2 segundos cada. Como inserimos as imagens? √â pelo campo `Conditions` do componente `loop`!! Por exemplo:
    - Crie uma planilha com um nome para a coluna, aqui escrevi `imagens`, e adicione o nome de todos os arquivos que voc√™ quer adicionar (no caso, o nome+tipo de todas as imagens). Ficou assim:
    
        | imagens |
        | --- |
        | foto1.png |
        | foto2.png |
        | foto3.png |
    Agora, vamos colocar nossa planilha no campo `Conditions` clicando no √≠cone de explorar de arquivos que est√° ao lado do campo vazio. Ap√≥s selecionarmos, podemos finalizar a edi√ß√£o do loop properties.

### `set every frame` vs `set every repeat` üõ†

J√° passamos por alguns componentes que tem as op√ß√µes de serem `Constant`, `set every frame` e `set every repeat`. Mas afinal, qual a diferen√ßa?
- `Constant` √© quando o valor determinado para o componente, seja uma foto, um v√≠deo, um texto, √© constante, ele n√£o muda e se manter√° assim at√© o final do experimento.
- `set every frame` √© quando voc√™ tem um componente que sofre mudan√ßas constantes, isto √©, a cada frame(quadro) que aparece na tela. Ele √© utilizado em componentes que usam anima√ß√µes, etc.
- `set every repeat` √© quando voc√™ tem um componente que sofre mudan√ßas no in√≠cio de cada nova itera√ß√£o do `loop`. Por exemplo, no nosso caso com as fotos citado acima, seria um `set every repeat`


### Utilizando v√°riaveis dentro das `Routines`! :exploding_head: 

Bom, muito legal! Acabamos de ver como adicionar repeti√ß√µes ao nosso experimento e isso abre in√∫meras possibilidades de montagem :D

Eu falei da cria√ß√£o de uma planilha, dos nomes dos arquivos, da inser√ß√£o da planilha na vari√°vel loop...Mas, como a imagem vai aparecer? Como o programa sabe qual imagem deve mostrar?

Isso envolve o uso de **vari√°veis** :performing_arts:

> **O que √© uma vari√°vel?** √© um elemento que pode assumir algum valor dentro de um conjunto de valores.

Na programa√ß√£o, o uso de vari√°veis √© base de tudo. 

O psychopy utiliza deste conceito embutido dentro de seu sistema, ent√£o mesmo dentro do `Builder View` existe a manipula√ß√£o de vari√°veis.

Vou dar o exemplo para ficar mais claro. Voltando √† pergunta inicial deste t√≥pico: Como a imagem vai aparecer?

Bom, da mesma forma como temos adicionado tudo no experimento, devemos adicionar um `Image Component` e ent√£o determinar em suas configura√ß√µes qual imagem queremos mostrar. Assim como no loop, tem um campo que permite que voc√™ abra pelo explorador de arquivos e selecione o arquivo desejado. 

Certo, mas, nesse caso eu quero mudar as imagens a cada loop, quero que cada imagem apare√ßa por um tempo de 2seg, como fa√ßo? A√≠ que vem a _vari√°vel_.

Lembra do nome da coluna que lista os arquivos em nossa planilha? Essa aqui:

| imagens |
| --- |
| foto1.png |
| foto2.png |
| foto3.png |

Sim, a coluna se chama `imagens`. Bom, apartir do momento que essa planilha est√° no `Conditions` do loop, temos que o `imagens` se tornou uma vari√°vel no sistema. Assim, a cada repeti√ß√£o ser√° atribu√≠do um dos valores das linhas √† vari√°vel `imagens`.

Assim, podemos referenci√°-la em qualquer parte de alguma das rotinas que se encontram dentro do loop!! Nos referenciamos vari√°veis utilizando um `$` na frente da palavra :)

> N√£o sei se voc√™ percebeu, mas alguns campos dentro das propriedades dos componentes possuem esse s√≠mbolo ao lado. Isso significa que s√£o campos que recebem vari√°veis!!

Logo, para o problema que prop√ªs, a resposta √© atribuir ao campo `Image` do componente o valor `$imagens`, e n√£o esquecer de mudar a configura√ß√£o de `constant` para `set every frame`. Logo, teremos que a cada repeti√ß√£o uma imagem diferente aparecer√°, pois o valor da vari√°vel est√° mudando e o componente da imagem est√° recebendo-o.

E ent√£o voc√™ me pergunta: Apenas colunas se tornam vari√°veis no Psychopy? A resposta √© n√£o! Voc√™ pode criar vari√°veis pelo programa, por exemplo criar vari√°veis que ficam dispon√≠veis at√© o final do experimento, al√©m dos loops. Isso vai envolver o chamado `Code component, que veremos em outra se√ß√£o :)

Ah, e al√©m disso, tamb√©m existem vari√°veis que j√° s√£o _built-in_ (j√° vem no programa), como √© o caso da vari√°vel `t`, que representa o tempo cronol√≥gico desde o in√≠cio do seu experimento.

### üòä Usando Loops para blocos
E se o nosso experimento tiver diferentes bases, com diferentes prop√≥sitos e quisermos aplicar os dois em um mesmo loop? Aleatorizando a apari√ß√£o de cada um? Bom, isso √© poss√≠vel!

Exemplo: imagine que voc√™ tem duas planilhas, a primeira se chama `frutas.csv`, e ela tem esse formato: uma coluna nomeada **imagens** e os seus valores.

| imagens | 
| ---- |
| banana.png |
| maca.png |
| pera.png |

J√° a segunda se chama `cidades.csv` e tem o seguinte formato: uma coluna nomeada **imagens** e os seus valores.

| imagens | 
| ---- |
| natal.png |
| toronto.png|
| belohorizonte.png |

Imagine agora que voc√™ deseja fazer um experimento onde o participante vai receber como est√≠mulo imagens de frutas e de cidades, aleatorizadas, uma de cada vez, por um pequeno per√≠odo de tempo, e ao final precisa responder o que lembra ter visto.

Logo, o desafio √© juntar as duas bases e misturar seus stimulus. Como faremos isso? O componente `loop` pode nos ajudar mais uma vez.


Primeiramente, iremos criar uma nova planilha, eu vou cham√°-la de `frutas_e_cidades.csv` mas voc√™ pode dar o nome que achar melhor.

Nessa planilha, criarei uma coluna chamada `planilhas` e adicionarei os nomes das nossas basess: `cidades.csv` e `frutas.csv`. Ficar√° da seguinte forma:

| planilhas | 
| ---- |
| frutas.csv |
| cidades.csv|

Logo, ap√≥s salvar o arquivo, podemos voltar ao Psychopy e modificar o nosso loop `trials`. Podemos renome√°-lo para `blocoTrials`, mudar o nome do `Conditions` para o nosso arquivo `frutas_e_cidades.csv` e desmarcar o `IsTrials`. 
<br>
<br>
<div align="center">
<img src="images/frutas_e_cidades.jpeg" height=300 >
</div>
<br>



üó∫ Lembra que eu comentei sobre o `isTrials` uns t√≥picos atr√°s? Bom, neste caso, estamos lidando com um loop que trabalha com blocos de trials, logo caso deixemos esse checkbox marcado, o data file final do nossos experimento ter√° uma linha a mais al√©m dos resultados das `trials` ap√≥s cada final de bloco. Para explicar melhor, o data file final teria como primeiras colunas algo desse tipo: 

| planilhas | images | blocoTrials.thisRepN |
| ---- | --- | ---- |
| frutas.csv | banana.png | 0 |
| frutas.csv | pera.png | 0 |
| frutas.csv | maca.png | 0 |
| frutas.csv | -  | 0 |
| cidades.csv| natal.png | 0 |
| cidades.csv | toronto.png | 0 |
| cidades.csv | belohorizonte.png | 0 |
| cidades.csv | - | 0 |

Note a presen√ßa de uma linha a mais com o valor de `imagens` vazio ap√≥s a finaliza√ß√£o de cada bloco de trials. Isso representa a passagem pelo loop, que ele tamb√©m conta. Mas s√£o linhas que n√£o importam neste experimento, ent√£o, deixamos o `isTrials` desmarcado.

Ap√≥s isso, adicionaremos um segundo loop! Isso mesmo. Este iremos inserir dentro do loop anterior, posicione-o ap√≥s o in√≠cio do loop `blocoTrials` e antes do final do mesmo. Ele ficar√° assim:
<br>
<br>
<div align="center">
<img src="images/nestedloop.jpeg" height=250 >
</div>
<br>

Nas propriedades do loop, iremos utilizar uma vari√°vel para indicar a coluna onde est√£o os nomes das planilhas!üò≤ Ou seja, no campo `Conditions` coloque o `$planilhas`, que ser√° reonhecido pelo programa por ser uma coluna na planilha `frutas_e_cidades.csv`. 

<br>
<br>
<div align="center">
<img src="images/trials_2.jpeg" height=300 >
</div>
<br>

Dessa vez, marque a op√ß√£o `isTrials` dado que ser√° um loop que demarca a repeti√ß√£o de trials em si, e n√£o de seus blocos.

Lembre que, como falamos anteriormente, voc√™ pode mudar as configura√ß√µes do loop como o seu tipo, quando vezes ser√° repetido, quais linhas da planilha ser√£o mostradas, etc.

Ap√≥s essa configura√ß√£o, adicione um componente de imagem na sua rotina `trial` e configure adicionando o valor `$imagens` ao campo `Image`.

Logo, inicie o experimento e voc√™ ver√° as imagens de frutas e cidades aparecendo de forma aleat√≥ria.

Para finalizar a implementa√ß√£o da ideia do experimento que dei nesta se√ß√£o, basta adicionar uma nova rotina, pode ser chamada de `resposta`, e adicionar um componente `TextBox` que recebe uma resposta do usu√°rio. Ent√£o determine a dura√ß√£o para infinito, e adicione um `Keyboard Response` que force a finaliza√ß√£o do experimento quando o participante clicar na barra de espa√ßo, por exemplo (voc√™ tamb√©m pode adicionar uma rotina de instru√ß√£o avisando sobre esse comportamento por um tempo antes de liberar a rotina `resposta`)
